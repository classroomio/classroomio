import Image from 'next/image';
import { Callout, Steps } from 'nextra/components';
import SupabaseStart from './images/start-result.webp';
import DBPush from './images/db-push-result.webp';

# Supabase Local Development (CLI + Docker)

This guide will help you run Supabase locally using the Supabase CLI and Docker for a fully local development setup (no Supabase Cloud required).

<Callout type="info">
  There are two ways you can work in development:
  <br />- <strong>Cloud‑backed local dev</strong>: You will have to complete the
  <a href="/contributor-guides/supabase-cloud">Supabase Cloud Setup</a> to create your project and
  get keys. Then follow the <strong>Cloud‑backed local development</strong> section below to link
  the project and <code>db push</code> the schema. Finally, point your app envs to the Cloud
  URL/keys.
  <br />- <strong>Fully local (CLI + Docker)</strong>: In this setup no supabase cloud is needed.
  Run
  <code>supabase start</code> to bring up local services and apply migrations locally. Link/push to
  a remote Cloud project only if/when you decide to sync changes upstream.
</Callout>

## Video walkthrough

This video will provide a walkthrough on how to setup ClassroomIO for local development using docker.

<div className="nx-w-full nx-flex nx-items-center nx-justify-center">
  <iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/dAZAZ0oiky0?si=1h-KtppNqJ3U4BTe"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    className="nx-my-4 nx-rounded-md"
    allowfullscreen
  ></iframe>
</div>

## Prerequisites

To develop locally with supabase cli and docker in ClassroomIO, you need to have the following;

- Docker Desktop installed and running
- Supabase CLI installed
- Node.js 18+

## Step-by-step

<Steps>

### 1. Initialize Supabase

First start by cloning our project into your preferred project folder, and from the root directory, install dependencies.

```bash
git clone https://github.com/rotimi-best/classroomio.git
cd classroomio
pnpm install
```

When all the dependencies needed have been installed, run the command below to Initialize supabase, ensure that docker is running before running this command.

```bash
#Initialize supabase
pnpm supabase init
```

### 2. Start supabase CLI.

To running supabase locally, run the following command

```bash
pnpm supabase start
```

This starts local Postgres, Auth, and Studio via Docker, applies migrations/seeds in the `supabase/` directory, and generates local connection settings.

<Image src={SupabaseStart} alt="Supabase start result" quality="100" />

<Callout type="info">
  Find local credentials with <code>supabase status</code> or in the generated <code>.env</code>{' '}
  files under <code>supabase/</code>.
</Callout>

### 3. Apply Migrations/Seeds (optional)

Migrations in `supabase/migrations` are applied automatically on start. To push new changes:

```bash
# After editing local DB
pnpm supabase db diff -f descriptive_name
```

This creates a shadow database from the migration files in the supabase/migration and checks for schema difference between the shadow database and local database, the output from this command is then used to create a migration file.

```bash
pnpm supabase migration up
```

This updates the local database with the database schema from migration files.

### 4. Configure ClassroomIO Apps for Local Supabase

Update your environment files to point to the local services.

For `apps/backend`:

```bash
cp apps/backend/.env.example apps/backend/.env
# Edit values
PUBLIC_SUPABASE_URL=http://localhost:54321
PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
# SMTP can be skipped locally if not testing email
```

For `apps/dashboard`:

```bash
cp apps/dashboard/.env.example apps/dashboard/.env
# Edit values
PUBLIC_SUPABASE_URL=http://localhost:54321
PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
PRIVATE_SUPABASE_SERVICE_ROLE=your_local_service_role_key
```

### 5. Run the apps

You can run each app individually using workspace filters, or run all dev services.

```bash
# From repository root

# Start dashboard only
pnpm --filter dashboard dev

# Start backend only
pnpm --filter backend dev

# Or start all dev services
pnpm dev
```

### 6. Stop/Reset the local stack

```bash
pnpm supabase stop
# optional: pnpm supabase db reset
```

</Steps>

## Cloud-backed local development (using Supabase Cloud as DB)

If you prefer using a Supabase Cloud project while developing locally:

1. Ensure you have completed the <a href="/contributor-guides/supabase-cloud">Supabase Cloud Setup</a>
2. Link your local repo to the remote project:

```bash
pnpm supabase:login    # one-time
pnpm supabase          # optional: prints help

# Link to your remote Supabase project
pnpm supabase link --project-ref YOUR_PROJECT_REF
```

3. Apply your local migrations to the remote database when needed:

```bash
pnpm supabase db push
```

<Image src={DBPush} alt="DB push result" quality="100" />

4. If you made changes directly on the remote (e.g., via SQL Editor), generate a migration file to commit locally:

```bash
# Creates a new SQL migration in supabase/migrations based on diff with linked remote
pnpm supabase db diff -f descriptive_name
```

## Migrations workflow (local Docker → remote Cloud)

When running Supabase locally via Docker and you want to migrate those schema changes to your remote Cloud project:

1. Make and test schema changes locally (with `supabase start` running)
2. Generate a migration file from local state:

```bash
pnpm supabase db diff -f descriptive_name
```

3. Link your remote project if not already linked:

```bash
pnpm supabase link --project-ref YOUR_PROJECT_REF
```

4. Push the generated migrations to the remote Cloud project:

```bash
pnpm supabase db push
```

## Notes

- Ensure ports used by Supabase (e.g., 54321/54322) are free.
- When switching between Cloud and Local, update app envs accordingly.
