{"version":3,"file":"posthog-persistence.js","sourceRoot":"","sources":["../../src/posthog-persistence.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint camelcase: \"off\" */\n\nimport { _each, _extend, _include, _strip_empty_properties } from './utils'\nimport { cookieStore, localStore, localPlusCookieStore, memoryStore, sessionStore } from './storage'\nimport { PersistentStore, PostHogConfig, Properties } from './types'\nimport {\n    PERSISTENCE_RESERVED_PROPERTIES,\n    EVENT_TIMERS_KEY,\n    ENABLED_FEATURE_FLAGS,\n    POSTHOG_QUOTA_LIMITED,\n    USER_STATE,\n} from './constants'\n\nimport { _isObject, _isUndefined } from './utils/type-utils'\nimport { _info } from './utils/event-utils'\nimport { logger } from './utils/logger'\n\nconst CASE_INSENSITIVE_PERSISTENCE_TYPES: readonly Lowercase<PostHogConfig['persistence']>[] = [\n    'cookie',\n    'localstorage',\n    'localstorage+cookie',\n    'sessionstorage',\n    'memory',\n]\n\n/**\n * PostHog Persistence Object\n * @constructor\n */\nexport class PostHogPersistence {\n    props: Properties\n    storage: PersistentStore\n    campaign_params_saved: boolean\n    custom_campaign_params: string[]\n    name: string\n    disabled: boolean | undefined\n    secure: boolean | undefined\n    expire_days: number | undefined\n    default_expiry: number | undefined\n    cross_subdomain: boolean | undefined\n    user_state: 'anonymous' | 'identified'\n\n    constructor(config: PostHogConfig) {\n        // clean chars that aren't accepted by the http spec for cookie values\n        // https://datatracker.ietf.org/doc/html/rfc2616#section-2.2\n        let token = ''\n\n        if (config['token']) {\n            token = config['token'].replace(/\\+/g, 'PL').replace(/\\//g, 'SL').replace(/=/g, 'EQ')\n        }\n\n        this.props = {}\n        this.campaign_params_saved = false\n        this.custom_campaign_params = config['custom_campaign_params'] || []\n\n        if (config['persistence_name']) {\n            this.name = 'ph_' + config['persistence_name']\n        } else {\n            this.name = 'ph_' + token + '_posthog'\n        }\n\n        if (\n            CASE_INSENSITIVE_PERSISTENCE_TYPES.indexOf(\n                config['persistence'].toLowerCase() as Lowercase<PostHogConfig['persistence']>\n            ) === -1\n        ) {\n            logger.critical(\n                'Unknown persistence type ' + config['persistence'] + '; falling back to localStorage+cookie'\n            )\n            config['persistence'] = 'localStorage+cookie'\n        }\n        // We handle storage type in a case-insensitive way for backwards compatibility\n        const storage_type = config['persistence'].toLowerCase() as Lowercase<PostHogConfig['persistence']>\n        if (storage_type === 'localstorage' && localStore.is_supported()) {\n            this.storage = localStore\n        } else if (storage_type === 'localstorage+cookie' && localPlusCookieStore.is_supported()) {\n            this.storage = localPlusCookieStore\n        } else if (storage_type === 'sessionstorage' && sessionStore.is_supported()) {\n            this.storage = sessionStore\n        } else if (storage_type === 'memory') {\n            this.storage = memoryStore\n        } else if (storage_type === 'cookie') {\n            this.storage = cookieStore\n        } else {\n            // selected storage type wasn't supported, fallback to 'localstorage+cookie' if possible\n            if (localPlusCookieStore.is_supported()) {\n                this.storage = localPlusCookieStore\n            } else {\n                this.storage = cookieStore\n            }\n        }\n\n        this.user_state = 'anonymous'\n\n        this.load()\n        this.update_config(config)\n        this.save()\n    }\n\n    properties(): Properties {\n        const p: Properties = {}\n        // Filter out reserved properties\n        _each(this.props, function (v, k) {\n            if (k === ENABLED_FEATURE_FLAGS && _isObject(v)) {\n                const keys = Object.keys(v)\n                for (let i = 0; i < keys.length; i++) {\n                    p[`$feature/${keys[i]}`] = v[keys[i]]\n                }\n            } else if (!_include(PERSISTENCE_RESERVED_PROPERTIES, k)) {\n                p[k] = v\n            }\n        })\n        return p\n    }\n\n    load(): void {\n        if (this.disabled) {\n            return\n        }\n\n        const entry = this.storage.parse(this.name)\n\n        if (entry) {\n            this.props = _extend({}, entry)\n        }\n    }\n\n    /**\n     * NOTE: Saving frequently causes issues with Recordings and Consent Management Platform (CMP) tools which\n     * observe cookie changes, and modify their UI, often causing infinite loops.\n     * As such callers of this should ideally check that the data has changed beforehand\n     */\n    save(): void {\n        if (this.disabled) {\n            return\n        }\n        this.storage.set(this.name, this.props, this.expire_days, this.cross_subdomain, this.secure)\n    }\n\n    remove(): void {\n        // remove both domain and subdomain cookies\n        this.storage.remove(this.name, false)\n        this.storage.remove(this.name, true)\n    }\n\n    // removes the storage entry and deletes all loaded data\n    // forced name for tests\n\n    clear(): void {\n        this.remove()\n        this.props = {}\n    }\n\n    /**\n     * @param {Object} props\n     * @param {*=} default_value\n     * @param {number=} days\n     */\n\n    register_once(props: Properties, default_value: any, days?: number): boolean {\n        if (_isObject(props)) {\n            if (_isUndefined(default_value)) {\n                default_value = 'None'\n            }\n            this.expire_days = _isUndefined(days) ? this.default_expiry : days\n\n            let hasChanges = false\n\n            _each(props, (val, prop) => {\n                if (!this.props.hasOwnProperty(prop) || this.props[prop] === default_value) {\n                    this.props[prop] = val\n                    hasChanges = true\n                }\n            })\n\n            if (hasChanges) {\n                this.save()\n                return true\n            }\n        }\n        return false\n    }\n\n    /**\n     * @param {Object} props\n     * @param {number=} days\n     */\n\n    register(props: Properties, days?: number): boolean {\n        if (_isObject(props)) {\n            this.expire_days = _isUndefined(days) ? this.default_expiry : days\n\n            let hasChanges = false\n\n            _each(props, (val, prop) => {\n                if (props.hasOwnProperty(prop) && this.props[prop] !== val) {\n                    this.props[prop] = val\n                    hasChanges = true\n                }\n            })\n\n            if (hasChanges) {\n                this.save()\n                return true\n            }\n        }\n        return false\n    }\n\n    unregister(prop: string): void {\n        if (prop in this.props) {\n            delete this.props[prop]\n            this.save()\n        }\n    }\n\n    update_campaign_params(): void {\n        if (!this.campaign_params_saved) {\n            this.register(_info.campaignParams(this.custom_campaign_params))\n            this.campaign_params_saved = true\n        }\n    }\n\n    update_search_keyword(): void {\n        this.register(_info.searchInfo())\n    }\n\n    update_referrer_info(): void {\n        this.register({\n            $referrer: this.props['$referrer'] || _info.referrer(),\n            $referring_domain: this.props['$referring_domain'] || _info.referringDomain(),\n        })\n    }\n\n    get_referrer_info(): Properties {\n        return _strip_empty_properties({\n            $referrer: this['props']['$referrer'],\n            $referring_domain: this['props']['$referring_domain'],\n        })\n    }\n\n    // safely fills the passed in object with stored properties,\n    // does not override any properties defined in both\n    // returns the passed in object\n\n    safe_merge(props: Properties): Properties {\n        _each(this.props, function (val, prop) {\n            if (!(prop in props)) {\n                props[prop] = val\n            }\n        })\n\n        return props\n    }\n\n    update_config(config: PostHogConfig): void {\n        this.default_expiry = this.expire_days = config['cookie_expiration']\n        this.set_disabled(config['disable_persistence'])\n        this.set_cross_subdomain(config['cross_subdomain_cookie'])\n        this.set_secure(config['secure_cookie'])\n    }\n\n    set_disabled(disabled: boolean): void {\n        this.disabled = disabled\n        if (this.disabled) {\n            this.remove()\n        } else {\n            this.save()\n        }\n    }\n\n    set_cross_subdomain(cross_subdomain: boolean): void {\n        if (cross_subdomain !== this.cross_subdomain) {\n            this.cross_subdomain = cross_subdomain\n            this.remove()\n            this.save()\n        }\n    }\n\n    get_cross_subdomain(): boolean {\n        return !!this.cross_subdomain\n    }\n\n    set_secure(secure: boolean): void {\n        if (secure !== this.secure) {\n            this.secure = secure\n            this.remove()\n            this.save()\n        }\n    }\n\n    set_event_timer(event_name: string, timestamp: number): void {\n        const timers = this.props[EVENT_TIMERS_KEY] || {}\n        timers[event_name] = timestamp\n        this.props[EVENT_TIMERS_KEY] = timers\n        this.save()\n    }\n\n    remove_event_timer(event_name: string): number {\n        const timers = this.props[EVENT_TIMERS_KEY] || {}\n        const timestamp = timers[event_name]\n        if (!_isUndefined(timestamp)) {\n            delete this.props[EVENT_TIMERS_KEY][event_name]\n            this.save()\n        }\n        return timestamp\n    }\n\n    get_user_state(): 'anonymous' | 'identified' {\n        return this.props[USER_STATE] || 'anonymous'\n    }\n\n    set_user_state(state: 'anonymous' | 'identified'): void {\n        this.props[USER_STATE] = state\n        this.save()\n    }\n\n    get_quota_limits(): Record<string, number> {\n        return this.props[POSTHOG_QUOTA_LIMITED] || {}\n    }\n\n    set_quota_limits(state: Record<string, number>): void {\n        this.props[POSTHOG_QUOTA_LIMITED] = state\n        this.save()\n    }\n}\n"]}