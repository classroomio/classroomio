# ClassroomIO
# Project: Self-hosted API and Dashboard
# Description: This docker-compose file sets up the api and dashboard services for self-hosting.
# Author: rotimi-best
# Date: 2024-09-18

version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: classroomio-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  whisper-api:
    image: onerahmet/openai-whisper-asr-webservice:latest-cpu
    container_name: classroomio-whisper
    ports:
      - "${WHISPER_PORT:-9000}:9000"
    environment:
      - ASR_MODEL=base
      - ASR_ENGINE=openai_whisper
    volumes:
      - whisper_models:/root/.cache/whisper
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  api:
    image: classroomio/api:latest
    ports:
      - "3081:3081"
    environment:
      - NODE_ENV=production
      # Supabase - Database
      - PUBLIC_SUPABASE_ANON_KEY=${PUBLIC_SUPABASE_ANON_KEY}
      - PUBLIC_SUPABASE_URL=${PUBLIC_SUPABASE_URL}
      # Cloudflare - Video upload
      - CLOUDFLARE_BUCKET_DOMAIN=${CLOUDFLARE_BUCKET_DOMAIN}
      - CLOUDFLARE_ACCESS_KEY=${CLOUDFLARE_ACCESS_KEY}
      - CLOUDFLARE_SECRET_ACCESS_KEY=${CLOUDFLARE_SECRET_ACCESS_KEY}
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID}
      - CLOUDFLARE_VIDEO_BUCKET_DOMAIN=${CLOUDFLARE_VIDEO_BUCKET_DOMAIN}
      # SMTP - Emails
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SENDER=${SMTP_SENDER}
      # Redis
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      # Whisper API
      - WHISPER_API_URL=${WHISPER_API_URL:-http://whisper-api:9000}
    depends_on:
      redis:
        condition: service_healthy
      whisper-api:
        condition: service_healthy

  dashboard:
    image: classroomio/dashboard:latest
    ports:
      - "3082:3082"
    environment:
      - PUBLIC_IS_SELFHOSTED=true
      # Supabase - Database
      - PUBLIC_SUPABASE_URL=${PUBLIC_SUPABASE_URL}
      - PUBLIC_SUPABASE_ANON_KEY=${PUBLIC_SUPABASE_ANON_KEY}
      - PRIVATE_SUPABASE_SERVICE_ROLE=${PRIVATE_SUPABASE_SERVICE_ROLE}
      - PRIVATE_APP_HOST=${PRIVATE_APP_HOST} # yourdomain.com
      - PRIVATE_APP_SUBDOMAINS=${PRIVATE_APP_SUBDOMAINS} # app (if you are using app.yourdomain.com for the dashboard)
      - UNSPLASH_API_KEY=${UNSPLASH_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PUBLIC_SERVER_URL=${PUBLIC_SERVER_URL} # this is the url to the api service
      - PUBLIC_IP_REGISTRY_KEY=${PUBLIC_IP_REGISTRY_KEY}
    depends_on:
      - api

volumes:
  redis_data:
    driver: local
  whisper_models:
    driver: local
