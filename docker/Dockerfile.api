FROM node:20.19.3-slim

WORKDIR /app

# Keep install non-interactive and deterministic in CI/container contexts.
ENV CI=true

RUN corepack enable && corepack prepare pnpm@10.19.0 --activate

COPY . .

RUN pnpm install --frozen-lockfile --ignore-scripts --shamefully-hoist --filter @cio/api...
RUN find . -name 'tsconfig.tsbuildinfo' -delete
RUN pnpm -r --filter @cio/api... build

EXPOSE 3081

ENV NODE_ENV=production \
    PORT=3081

CMD ["pnpm", "--filter", "@cio/api", "start"]
